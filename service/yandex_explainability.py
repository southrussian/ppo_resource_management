from __future__ import annotations
from yandex_cloud_ml_sdk import YCloudML
from dotenv import load_dotenv
import os

load_dotenv()


def yandex_explain(logs, agent_id) -> str:
    """
       Анализирует логи агента и генерирует объяснение его поведения с использованием модели Yandex Cloud ML.

       Эта функция подключается к Yandex Cloud ML SDK, формирует запрос на основе предоставленных логов и идентификатора агента,
       и возвращает текстовое объяснение, которое включает восстановление модели BDI агента, обобщение его поведения
       и выявление ключевых факторов, влияющих на его решения.

       Args:
           logs (str): Логи агента, содержащие данные о его действиях и состояниях.
           agent_id (int): Идентификатор агента, для которого требуется объяснение.

       Returns:
           str: Текстовое объяснение поведения агента на основе модели BDI.

       Notes:
           - Функция использует библиотеку dotenv для загрузки переменных окружения.
           - Подключение к Yandex Cloud ML осуществляется с использованием идентификатора папки и данных авторизации.
           - Ответ от модели обрабатывается и возвращается в виде строки.

       Example:
           logs = "Данные логов агента..."
           agent_id = 1
           explanation = yandex_explain(logs, agent_id)
           print(explanation)
       """
    sdk = YCloudML(
        folder_id=os.getenv('FOLDER_ID'),
        auth=os.getenv('AUTH'),
    )

    messages = [
        {
            "role": "system",
            "text": """
        Ты — интеллектуальная система для планирования грузоперевозок на складе. 
        Твоя задача — анализировать данные агентов и выбирать оптимальные дни для отправки грузов. 
    
        Концепция BDI (Belief-Desire-Intention):
        1. Срочность: 1-3 (1 — низкая, 3 — высокая).
        2. Полнота информации: 0-1 (0 — неполная, 1 — полная).
        3. Сложность задания: 1-3 (1 — низкая, 3 — высокая).
        4. Занятость мест: предыдущий/текущий/следующий день.
        """,
        },
        {
            "role": "system",
            "text": f"""
            Прочти данные из логов: {logs}
            """,
        },
        {
            "role": "system",
            "text": f"""
                Инструкции:
                1. Восстанови модель BDI {agent_id + 1}-го агента на основе данных.
                2. Обобщи поведение агента: 
                   - Определи, были ли действия пассивными или активными.
                   - Проанализируй динамику поведения за весь период.
                3. Выяви ключевые факторы, влияющие на решения агента.

                Требования:
                - Ответ должен быть в виде сплошного текста без форматирования.
                - Не используй маркеры, заголовки или жирный шрифт.
                - Пиши кратко, но информативно.
                """,
        }
    ]

    result = (
        sdk.models.completions("yandexgpt").configure(temperature=0.1).run(messages)
    )

    for alternative in result:
        print(alternative.text)
        return str(alternative.text)
